---
title: "B & T cell analysis"
output: 
  html_document:
      code_folding: hide
      toc: true
      toc_float: true
---


```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE, warning = FALSE, message = FALSE, cache = TRUE, cache.lazy = FALSE, fig.width = 8, fig.height = 4.5)
```

```{r, echo = TRUE}
library(tidyverse)
library(readxl)
library(ComplexHeatmap)
library(textclean)
library(survival)
library(survminer)
library(circlize)
library(glmnet)
library(reticulate)
library(ggupset)
library(ggforce)
library(RColorBrewer)
library(ggcorrplot)
library(Hmisc)
```

# Data

```{r}
clinical_data_file <- "../bc-1508_tma_clin_data_2023-08-07.xlsx"
b_t_revised_data_file <- "../data/b_t_data_revised.tsv"

clinical_data <- read_excel(clinical_data_file, sheet = "bc-1508", na = c("", "NA", "n/a", "Unk"))
b_t_data_revised <- read_tsv(b_t_revised_data_file, na = c("", "NA", "n/a", "x", "n/a- Pathologist annotated"))
```

```{r}
# Clinical data table contains some invisible characters
clinical_data <- clinical_data %>%
  mutate(acc_num=replace_non_ascii(acc_num),
         study_id=replace_non_ascii(study_id)) %>%
  ## Remove leading zeros after hyphens, these are inconsistently formatted in both tables :(
  mutate(acc_num=str_replace(acc_num, "-(0+)", "-")) %>%
  mutate(age_dx=as.numeric(age_dx),
         age_surg=as.numeric(age_surg),
         tx=str_replace(tx, " only", "")) %>%
  mutate(
    chemo = grepl("chemo", tx),
    rt = grepl("RT", tx),
    brachy = grepl("brachy", tx)
  ) %>%
  mutate(
    ## Temporary solution, of no relevance as p53abn is the focus anyways
    eclass2_ngs=dplyr::recode(eclass2_ngs, "discrepant: MMRd, NSMP/p53wt"="NSMP/p53wt"),
    eclass2_pt=dplyr::recode(eclass2_pt, "discrepant: MMRd, NSMP/p53wt"="NSMP/p53wt")
  )

# Create unique identifier column
b_t_data_revised <- b_t_data_revised %>%
  mutate(`Accession#`=str_replace(`Accession#`, "-(0+)", "-"))
```


```{r}
colname_map <- c(
  'Accession#'='acc_num',
  'Block#'='block',
  'StudyID'='study_id1',
  'CoreID'='core_id1',
  'array'='tma',
  'subarray'='subarray',
  'Image Tag'='image_path',
  'Notes'='notes',
  '% tumour area2'='area_tumour_pct',
  '% stroma area2'='area_stroma_pct',
  "tissue area (mm²)"='area_tissue_mm',
  "tumour area (mm²)"='area_tumour_mm',
  "stroma area (mm²)"='area_stroma_mm',
  "TUMOUR CD20+CD79a+ (cells/mm2)"='dens_bcell_cd20pos_tumour',
  "STROMA CD20+CD79a+ (cells/mm2)"='dens_bcell_cd20pos_stroma',
  "TUMOUR CD20-CD70a+ (cells/mm2)"='dens_bcell_cd20neg_tumour',
  "STROMA CD20-CD70a+ (cells/mm2)"='dens_bcell_cd20neg_stroma',
  "TUMOUR CD3+CD8+FOXP3+ (cells/mm2)"='dens_cd8tcell_foxp3pos_tumour',
  "STROMA CD3+CD8+FOXP3+ (cells/mm2)"='dens_cd8tcell_foxp3pos_stroma',
  "TUMOUR CD3+CD8-FOXP3+ (cells/mm2)"='dens_treg_tumour',
  "STROMA CD3+CD8-FOXP3+ (cells/mm2)"='dens_treg_stroma',
  "TUMOUR CD3+CD8-FOXP3- (cells/mm2)"='dens_thelper_tumour',
  "STROMA CD3+CD8-FOXP3- (cells/mm2)"='dens_thelper_stroma',
  "TUMOUR CD3+CD8+FOXP3- (cells/mm2)"='dens_tcyto_tumour',
  "STROMA CD3+CD8+FOXP3- (cells/mm2)"='dens_tcyto_stroma',
  "TUMOUR CD20+CD79a+2"='count_bcell_cd20pos_tumour',
  "STROMA CD20+CD79a+3"='count_bcell_cd20pos_stroma',
  "TUMOUR CD20-CD70a+4"='count_bcell_cd20neg_tumour',
  "STROMA CD20-CD70a+5"='count_bcell_cd20neg_stroma',
  "TUMOUR CD3+CD8+FOXP3+"='count_cd8tcell_foxp3pos_tumour',
  "STROMA CD3+CD8+FOXP3+"='count_cd8tcell_foxp3pos_stroma',
  "TUMOUR CD3+CD8-FOXP3+"='count_treg_tumour',
  "STROMA CD3+CD8-FOXP3+"='count_treg_stroma',
  "TUMOUR CD3+CD8-FOXP3-"='count_thelper_tumour',
  "STROMA CD3+CD8-FOXP3-2"='count_thelper_stroma',
  "TUMOUR CD3+CD8+FOXP3-12"='count_tcyto_tumour',
  "STROMA CD3+CD8+FOXP3-13"='count_tcyto_stroma'
)
## MAKE SURE THAT WE PROPERLY ACCOUNT FOR CASES WHERE SPENCER HAS MANUALLY ANNOTATED SO AREAS NOT AVAILABLE? 

til_data <- b_t_data_revised %>% 
  rename_with(~ colname_map[.], .cols = names(colname_map)) %>%
  filter(ifelse(is.na(notes), TRUE, !str_detect(notes, pattern = "(Exclude|exclude)"))) %>%
  mutate(acc_num=str_replace(acc_num, " \\(.*", "")) %>%
  select(unname(colname_map)) %>%
  select(-image_path)

til_data_long <- til_data %>%
  pivot_longer(cols = all_of(colnames(til_data)[str_detect(colnames(til_data), "^(dens|area|count)")]), 
               names_to = "variable", 
               values_to = "value")
```

```{r}
area_distributions <- til_data_long %>%
  filter(str_detect(variable, "^area")) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 10, fill = "lightblue", color = "black") +
  facet_wrap(vars(variable), scales = "free") +
  labs(title = "Variables") + 
  theme_pubclean() + 
  ggtitle("Region area per core")

count_distributions <- til_data_long %>%
  filter(str_detect(variable, "^count")) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black") +
  scale_x_continuous(trans = 'log1p', breaks = c(0, 1, 10, 100, 1000, 10000),
                     labels = c("0", "1", "10", "100", "1000", "10000")) + 
  facet_wrap(vars(variable), scales = "free") +
  labs(title = "Variables") + 
  theme_pubr() + 
  ggtitle("Count per core")

density_distributions <- til_data_long %>%
  filter(str_detect(variable, "^dens")) %>%
  filter(!str_detect(variable, "cd8tcell_foxp3pos")) %>%
  mutate(variable = dplyr::recode(variable,
                                  dens_bcell_cd20pos_tumour="Tumour: B cell",
                                  dens_bcell_cd20neg_tumour="Tumour: Plasma",
                                  dens_tcyto_tumour="Tumour: CD8+",
                                  dens_thelper_tumour="Tumour: CD4+",
                                  dens_treg_tumour="Tumour: Treg",
                                  dens_bcell_cd20pos_stroma="Stroma: B cell",
                                  dens_bcell_cd20neg_stroma="Stroma: Plasma",
                                  dens_tcyto_stroma="Stroma: CD8+",
                                  dens_thelper_stroma="Stroma: CD4+",
                                  dens_treg_stroma="Stroma: Treg",
                                  )) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black") +
  scale_x_continuous(trans = 'log1p', breaks = c(0, 1, 10, 100, 1000, 10000),
                     labels = c("0", "1", "10", "100", "1000", "10000")) + 
  facet_wrap(vars(variable), scales = "free") +
  theme_pubr() +
  xlab("Density") + 
  ylab("Count")
```

## Region area distribution

```{r, fig.width=6, fig.height=4}
area_distributions
```

## Count distribution

```{r, fig.width=8, fig.height=6}
count_distributions
```

## Density distribution

```{r, fig.width=8, fig.height=6}
density_distributions
```

The densities follow a zero-inflated log-normal distribution. As such, log transformation of the density data prior to analysis is sensible, but will likely struggle from over-emphasis of differences at the lower end of the distribution, which may be fairly substantial due to the number of zeros. As such, generalized linear modeling will better fit the data, and thus give more accurate estimates, than linear models on log-transformed data. 

```{r}
til_counts_long <- til_data %>%
  pivot_longer(cols = colnames(til_data)[startsWith(colnames(til_data), "count")],
               names_to = "variable", 
               values_to = "value") %>%
  mutate(area_region_mm=ifelse(str_detect(variable, "tumour"),
                               area_tumour_mm,
                               area_stroma_mm))

## Summarized densities, grouping by sample/block ID
til_densities_sum_long <- til_counts_long %>%
  group_by(acc_num, variable) %>%
  summarise(
    var=var(value/area_region_mm),
    var_count=var(value),
    count=round(sum(value), 0),
    value=sum(value)/sum(area_region_mm),
    area=sum(area_region_mm)
  ) %>%
  ungroup() %>%
  mutate(variable = str_replace(variable, "^count", "dens"),
         unique_id=acc_num) %>%
  select(unique_id, everything())
```

## Mean-variance relationship

```{r, fig.width=6, fig.height=4}
ggplot(til_densities_sum_long, aes(x=count, y=var_count)) + 
  geom_point(alpha = 0.3) +
  stat_smooth(method="loess", colour="blue", alpha = 0.3) + 
  facet_wrap(~ variable) + 
  theme_minimal() + 
  scale_x_continuous(trans = "log1p", breaks = c(0, 1, 10, 100, 1000, 10000)) + 
  scale_y_continuous(trans = "log1p", breaks = c(0, 1, 10, 100, 1000, 10000)) + 
  geom_abline(slope=1, colour='red', alpha = 0.3) + 
  xlab("Count") + 
  ylab("Variance")
```

The mean-variance relationship for counts is *almost* linear, but clearly shows a bias for $\sigma^2 > \mu$. The significance of this is that it implies that a Poisson model of counts will underestimate $\sigma$. Thus, we are better off using a negative binomial model. 

# Survival modeling

```{r}
important_densities <- c(
  "dens_bcell_cd20pos_tumour",
  "dens_bcell_cd20pos_stroma",
  "dens_bcell_cd20neg_tumour",
  "dens_bcell_cd20neg_stroma",
  "dens_treg_tumour",
  "dens_treg_stroma",
  "dens_thelper_tumour",
  "dens_thelper_stroma",
  "dens_tcyto_tumour",
  "dens_tcyto_stroma"
)

til_densities <- til_densities_sum_long %>%
  mutate(value = log1p(value)) 

til_densities_wide <- til_densities %>%
  select(-c(count, area, var, var_count)) %>%
  filter(variable %in% important_densities) %>%
  pivot_wider(names_from = variable, values_from = value)

til_densities_heatmap_input <- til_densities_wide %>% select(colnames(til_densities_wide)[str_detect(colnames(til_densities_wide), "^dens")]) %>% as.matrix
rownames(til_densities_heatmap_input) <- til_densities_wide$unique_id
```

```{r}
group_by_cols <- setdiff(colnames(clinical_data), c("tma", "core_id"))

clinical_data_unique <- clinical_data %>% 
  group_by_at(group_by_cols) %>%
  summarise(across(everything(), ~ paste(., collapse = ","))) %>%
  ungroup()

clinical_anno <- clinical_data_unique %>%
  select(acc_num, tma, grade_rev, hist_rev, neoadj, eclass2_ngs) %>%
  mutate(unique_id=acc_num) %>%
  column_to_rownames("unique_id") %>%
  select(-c(acc_num))
```

## Data summary

We can use hierarchical clustering on log-transformed densities to visualize high-level patterns in the data. 

```{r, fig.width = 10, fig.height = 5}
input_mat <- scale(til_densities_heatmap_input %>% na.omit)

## REMOVE THIS IF YOU WANT THE ENTIRE COHORT 
#input_mat <- input_mat[which(row_anno$eclass2_ngs == "p53abn"),] %>% scale

row_hclust <- hclust(dist(input_mat), method = "ward.D2")
col_hclust <- hclust(dist(t(input_mat)), method = "ward.D2")

til_clusters <- cutree(row_hclust, 2)
names(til_clusters) <- rownames(input_mat)

pca_res <- prcomp(input_mat)

row_anno <- clinical_anno[rownames(input_mat),]
row_anno$til_clusters <- factor(unname(til_clusters))
hist_mapping <- c("endometrioid (squamous)" = "endometrioid", 
                  "mixed endometrioid and serous" = "mixed", 
                  "mixed serous and moderately differentiated" = "mixed",
                  "undifferentiated" = "undiff/dediff",
                  "dedifferentiated" = "undiff/dediff")
row_anno <- row_anno %>%
  mutate(hist_rev = case_when(
    hist_rev %in% names(hist_mapping) ~ hist_mapping[hist_rev],
    TRUE ~ hist_rev 
  ))
row_anno <- row_anno %>%
  cbind(pca_res$x[,1:4])

ha <- rowAnnotation(df = row_anno, annotation_width = 0.02, col = list(
  PC1=colorRamp2(c(min(row_anno$PC1), 0, max(row_anno$PC1)), c("blue", "white", "red")),
  PC2=colorRamp2(c(min(row_anno$PC2), 0, max(row_anno$PC2)), c("blue", "white", "red")),
  PC3=colorRamp2(c(min(row_anno$PC3), 0, max(row_anno$PC3)), c("blue", "white", "red")),
  PC4=colorRamp2(c(min(row_anno$PC4), 0, max(row_anno$PC4)), c("blue", "white", "red"))))

density_heatmap <- Heatmap(input_mat,
                           na_col = "gray",
                           column_names_gp = gpar(fontsize = 6), 
                           cluster_rows = row_hclust,
                           cluster_columns = col_hclust,
                           column_names_rot = 45, 
                           show_row_names = FALSE) + ha


draw(density_heatmap, heatmap_legend_side = "right")
```

As expected, POLE mutant samples are some of the most immune-infiltrated. MMRd also appears to be overrepresented in the high-immune cluster. Otherwise, the remainder of the categorical variables appear to be randomly distributed. The top 4 principal components derived from the density data are shown as annotation columns. 

Somewhat surprisingly, none of the clusters appear to correspond to a high-stromal TIL, low-tumor TIL group. Rather, cluster 2 has intermediate amounts of both tumor and stromal TIL. 

```{r, fig.width = 7, fig.height = 7}
dens_cors <- rcorr(input_mat, type = "pearson")


ggcorrplot(dens_cors$r, 
           hc.order = TRUE,
           type = "lower",
           p.mat = dens_cors$P)
```


## Kaplan-Meier models


```{r}
til_clust_df <- data.frame(acc_num=names(til_clusters), 
                           til_cluster=til_clusters,
                           pca_res$x[,1:4],
                           input_mat) %>%
  na.omit()

til_clusters_clinical <- clinical_data_unique %>%
  inner_join(til_clust_df)
```

```{r}
til_clusters_clinical_long <- til_clusters_clinical %>%
  pivot_longer(
    cols = c(starts_with("os"), starts_with("pfs"), starts_with("dss")),
    names_to = c("outcome", ".value"),
    names_sep = "_"
  ) %>%
  mutate(sts = str_extract(sts, "(?<=\\.).*"),
         yrs = as.numeric(yrs),
         til_cluster = factor(til_cluster),
         sts = (sts == "event")) %>%
  filter(!is.na(yrs)) %>%
  rename(time=yrs,
         status=sts) %>%
  ## time == 0 not allowed in cox model
  filter(time > 0)
```

```{r}
# Subset for p53abn
outcomes <- til_clusters_clinical_long$outcome %>% unique

fit_data <- lapply(outcomes, function(x) {
  til_clusters_clinical_long %>% filter(outcome == x)
})
names(fit_data) <- outcomes

fits <- lapply(outcomes, function(x) {
  survfit(Surv(time, status) ~ til_cluster, 
          data = fit_data[[x]] %>% filter(eclass2_ngs == "p53abn"))
})
names(fits) <- outcomes

ggsurvplot(fits, 
           data = fit_data %>% lapply(function(x) x %>% filter(eclass2_ngs == "p53abn")),
           pval = TRUE,
           pval.method = TRUE,
           conf.int = TRUE,
           risk.table = TRUE, 
           ggtheme = theme_pubr())
```


Restricting to p53abn samples, we don't find anything significant on KM analysis. The results are similar for 3 clusters, and whether or not we include the other molecular subtypes in the initial hierarchical clustering. 

## Cox models

We can use Cox proportional hazards modeling to incorporate more covariates. 

### Entire cohort

```{r, fig.width = 8, fig.height = 6}
cox_fits <- lapply(outcomes, function(x) {
  dat <- fit_data[[x]] %>%
    mutate(age_dx=scale(age_dx)) %>%
    mutate(til_cluster=factor(til_cluster, levels = c("1", "2", "3")),
           lvi = factor(lvi, levels = c("negative", "focal", "positive", "extensive")))
  coxph(Surv(time, status) ~ til_cluster + age_dx + strata(chemo) + rt + brachy + eclass2_ngs,
          data = dat)
})

#ftest <- cox.zph(cox_fits[[1]])
#ggcoxzph(ftest)

cox_fits[[1]]
cox_fits[[2]]
cox_fits[[3]]
```

### Only p53abn

```{r, fig.width = 8, fig.height = 6}
cox_fits_p53abn <- lapply(outcomes, function(x) {
  dat <- fit_data[[x]] %>%
    filter(eclass2_ngs == "p53abn") %>%
    mutate(age_dx=scale(age_dx)) %>%
    mutate(til_cluster=factor(til_cluster, levels = c("1", "2", "3")),
           lvi = factor(lvi, levels = c("negative", "focal", "positive", "extensive")))
  coxph(Surv(time, status) ~ til_cluster + age_dx + strata(chemo) + rt + brachy,
          data = dat)
})

#ftest <- cox.zph(cox_fits_p53abn[[1]])
#ggcoxzph(ftest)

cox_fits_p53abn[[1]]
cox_fits_p53abn[[2]]
cox_fits_p53abn[[3]]
```

Restricting to p53abn cases, the results are not significant at the $p < 0.05$ level for TIL cluster.

As we saw before, this may be because log-transforming our count/density data is not optimal. Given the mean-variance relationship of counts, where $\sigma^2 > \mu$, we will fit a negative binomial mixture model to counts in order to infer the latent TIL clusters. In order to incorporate uncertainty in cluster assignment into the survival model, we will create a generative model that we can draw from with Hamiltonian Monte Carlo.

```{r}
til_counts_wide <- til_counts_long %>%
  group_by(acc_num, variable) %>%
  summarise(
    count=round(sum(value), 0),
    area=sum(area_region_mm)
  ) %>%
  ungroup() %>%
  mutate(region=str_extract(variable, "stroma|tumour"),
         variable=str_replace(variable, "_stroma|_tumour", "")) %>%
  arrange(acc_num)

fit_data_all <- lapply(fit_data, function(x) {
  x %>% 
    mutate(stage_main=str_extract(stage_full, "I*V*")) %>%
    filter(!is.na(eclass2_ngs),
           !is.na(stage_main),
           !is.na(age_dx)) %>%
    filter(acc_num %in% til_counts_wide$acc_num) %>%
    arrange(acc_num)
})

fit_data_p53abn <- lapply(fit_data, function(x) {
  x %>% 
    mutate(stage_main=str_extract(stage_full, "I*V*")) %>%
    filter(!is.na(eclass2_ngs),
           !is.na(stage_main),
           !is.na(age_dx)) %>%
    filter(eclass2_ngs == "p53abn") %>%
    filter(acc_num %in% til_counts_wide$acc_num) %>%
    arrange(acc_num)
})

til_counts_wide_filtered_all <- lapply(fit_data_all, function(x) {
  til_counts_wide %>% 
    filter(acc_num %in% x$acc_num)
})

til_counts_wide_filtered_p53abn <- lapply(fit_data_p53abn, function(x) {
  til_counts_wide %>% 
    filter(acc_num %in% x$acc_num)
})
```

```{r, eval = FALSE}
write_feather(til_counts_wide_filtered_p53abn$os, path = "../data/survival_model_inputs/p53abn/til_counts_wide_os.feather")
write_feather(fit_data_p53abn$os, path = "../data/survival_model_inputs/p53abn/fit_data_os.feather")
write_feather(til_counts_wide_filtered_p53abn$pfs, path = "../data/survival_model_inputs/p53abn/til_counts_wide_pfs.feather")
write_feather(fit_data_p53abn$pfs, path = "../data/survival_model_inputs/p53abn/fit_data_pfs.feather")
write_feather(til_counts_wide_filtered_p53abn$dss, path = "../data/survival_model_inputs/p53abn/til_counts_wide_dss.feather")
write_feather(fit_data_p53abn$dss, path = "../data/survival_model_inputs/p53abn/fit_data_dss.feather")
```

```{r, eval = FALSE}
write_feather(til_counts_wide_filtered_all$os, path = "../data/survival_model_inputs/all/til_counts_wide_os.feather")
write_feather(fit_data_all$os, path = "../data/survival_model_inputs/all/fit_data_os.feather")
write_feather(til_counts_wide_filtered_all$pfs, path = "../data/survival_model_inputs/all/til_counts_wide_pfs.feather")
write_feather(fit_data_all$pfs, path = "../data/survival_model_inputs/all/fit_data_pfs.feather")
write_feather(til_counts_wide_filtered_all$dss, path = "../data/survival_model_inputs/all/til_counts_wide_dss.feather")
write_feather(fit_data_all$dss, path = "../data/survival_model_inputs/all/fit_data_dss.feather")
```

## Individual TIL densities and ratios

For the p53abn cohort, we'll do Cox modeling of the individual TIL variables and densities. Obviously we can't include everything in one model, as that will quickly lead to overparametrization and nondeterminism. 


```{r}
# The TIL densities here are not transformed
til_ratios_long <- til_densities_sum_long %>%
  mutate(
    region = str_extract(variable, "(tumour|stroma)$"),
    celltype = str_extract(variable, "(?<=dens_).*(?=_(tumour|stroma))")
  ) %>%
  group_by(unique_id, acc_num, region) %>%
  summarise(
    ratio_tcyto_treg=value[celltype == "tcyto"]/value[celltype == "treg"],
    ratio_thelper_treg=value[celltype == "thelper"]/value[celltype == "treg"],
    ratio_tcytothelper_treg=(value[celltype == "tcyto"] + value[celltype == "thelper"])/value[celltype == "treg"],
    ratio_thelper_tcyto=value[celltype == "thelper"]/value[celltype == "tcyto"],
    ratio_bcell_plasma=value[celltype == "bcell_cd20pos"]/value[celltype == "bcell_cd20neg"]
  ) %>%
  ungroup() %>%
  gather(key = variable,
         value = value,
         -c(unique_id, acc_num, region)) %>%
  mutate(variable = paste0(variable, "_", region)) %>%
  select(-c(region))

til_variables_long <- til_ratios_long %>%
  bind_rows(
    til_densities_sum_long %>%
      select(unique_id, acc_num, variable, value)
  )
  
til_variables_clinical_long <- til_variables_long %>%
  inner_join(clinical_data_unique)

til_variables_clinical_long <- til_variables_clinical_long %>%
  pivot_longer(
    cols = c(starts_with("os"), starts_with("pfs"), starts_with("dss")),
    names_to = c("outcome", ".value"),
    names_sep = "_"
  ) %>%
  mutate(sts = str_extract(sts, "(?<=\\.).*"),
         yrs = as.numeric(yrs),
         sts = (sts == "event")) %>%
  filter(!is.na(yrs)) %>%
  rename(time=yrs,
         status=sts) %>%
  ## time == 0 not allowed in cox model
  filter(time > 0)



cox_fits_tilvariables <- lapply(unique(til_variables_clinical_long$variable), function(tilvar) {
  df <- til_variables_clinical_long %>% 
    filter(variable == tilvar,
           eclass2_ngs == "p53abn") %>%
    mutate(
      age_dx = scale(age_dx)[,1],
      stage_main=str_extract(stage_full, "I*V*"),
      # Log1p on value
      value=log1p(value)
    ) %>%
    filter(!is.nan(value) & !is.infinite(value))
  
  merged_coefficients <- lapply(unique(df$outcome), function(survtype) {
    df <- df %>% 
      filter(outcome == survtype)
    
    survformula <- as.formula(paste0("Surv(time, status) ~  age_dx +  chemo + rt + brachy + stage_main + value"))
    
    coxres <- coxph(survformula, data = df)
    
    coeftable <- summary(coxres)$coefficients %>%
      bind_cols(summary(coxres)$conf.int[,3:4]) %>%
      as_tibble() %>%
      mutate(variable = rownames(summary(coxres)$coefficients)) %>%
      mutate(
        model_run = tilvar,
        outcome=survtype
      )
    coeftable
  }) %>% bind_rows()
  
  merged_coefficients
}) %>% bind_rows()
```

```{r, fig.height = 11, fig.width = 6}
ggplot(cox_fits_tilvariables %>% filter(variable == "value"), aes(y=model_run, group=outcome, colour=outcome)) + 
  geom_point(aes(x=`exp(coef)`), position=position_dodge(width=0.5), shape=15, size=3) + 
  geom_linerange(aes(xmin=`lower .95`, xmax=`upper .95`), position=position_dodge(width=0.5)) + 
  theme_pubr() + 
  geom_vline(xintercept = c(0.1, 0.2, 0.5, 2, 4), linetype = 3) + 
  geom_vline(xintercept = 1, alpha = 0.7) + 
  ylab("") + 
  scale_y_discrete(limits = rev) + 
  scale_colour_manual(values = brewer.pal(3, "Set2")) + 
  xlab("Hazard ratio") + 
  scale_x_continuous(trans = "log", breaks = c(0.1, 0.2, 0.5, 1, 2, 4))
```


## Negative binomial mixture model

### Explanation

We formulate a probabilistic model utilizing a negative binomial mixture for TIL counts, combined with Cox proportional hazards for survival analysis (which naturally incorporates information about uncertainty in cluster assignment into the survival model). 

```{tikz, fig.cap = "Graphical model", fig.ext = 'png', echo = FALSE}
\usetikzlibrary{bayesnet}
\begin{tikzpicture}[x=1.7cm,y=1.8cm]

    % Nodes
  
    \node[obs]                   (y)      {$y$} ; %
    \node[latent, above=.4 of y]    (mu)      {$\mu$} ; %
    \node[latent, left=.2 of y] (alpha) {$\alpha$} ;


    \node[obs, left= .4 of mu] (A) {$A$} ;
    \node[latent, above = .4 of mu] (z) {$z$} ;

    \node[latent, right = 0.3 of mu] (clust) {$c$} ;

    \node[det, right = 0.8 of clust, minimum size=.1pt] (xbetadot) {$\odot$} ;
    \node[obs, above right= .4 of xbetadot] (beta) {$\beta$} ;
    \node[latent, above left = .4 of xbetadot] (x) {$x$} ;


    

    \node[obs, below = .6 of xbetadot] (d) {$d, p$} ;

  
    \edge{mu} {alpha};
    \edge{mu,alpha} {y};
    \edge{A,z,clust} {mu} ;
    \edge{x, beta, clust} {xbetadot} ;
    \edge{xbetadot} {d} ;

    

    \plate {covariate} {(x) (beta) (xbetadot)} {$V$} ;
    \plate {cluster} {(z)} {$C$} ;
    \plate {region} {(A) (z) (mu) (y) (alpha) (cluster)} {$R$} ;
    \plate {core} {(A) (mu) (alpha) (y) (clust) (d) (region) (x) (xbetadot)} {$N$} ;
    % \plate {gene} {(beta) (delta) (rho) (mu) (alpha) (y) (cell.south east)} {$G$} ;
  

  
  \end{tikzpicture}
```

We describe TIL counts $y_{i,c,r}$ for a given core $i$, cell type $t$, and region (tumour/stroma) $r$ as follows:

$$
y_{i,t,r} \sim \mathcal{NB}(\mu_{i,t,r}, \alpha_{i,t,r})
$$
where the mean $\mu_{i,t,r}$ follows:

$$
\begin{aligned}
\mu_{i,t,r} &= A_{i,r} z_{c_i,t,r} \\
z_{c,t,r} &\sim \mathcal{Gamma}(\bar{\mu}_{t,r}, 100)
\end{aligned}
$$
where $c_i$ is the inferred cluster of core $i$, $A_{i,r}$ is the area of region $r$ in core $i$, and $\bar{\mu}_{t,r}$ is the mean density (count divided by area) value across all cores $i$. The conjugate Gamma distribution is parametrized in terms of a mean parameter and a scale parameter, with the scale parameter set to 100 to allow for a fairly uninformed prior. 

The dispersion parameter $\alpha_{i,t,r}$ is formulated in terms of a radial-basis function with parameters $a_k$ and $b_k$, for a specified number of centers $\bar{y}_k$ uniformly distributed between 0 and the maximum number of counts, with the default number of centers set equal to 20. 

$$
\begin{aligned}
\alpha_{i,t,r} &= \sum_k a_k \exp(-b_k (z_{c_i,t,r} - \bar{y}_k)^2) \\
a_k &\sim \mathcal{Lognormal}(0, 1) \\
b_k &\sim \mathcal{Lognormal}(0, 1)
\end{aligned}
$$

where $a_k$ and $b_k$ follow relatively agnostic lognormal priors as above. 

Next, we define variables $\beta_{c}$ corresponding to the Cox proportional-hazards log coefficient for each cluster $c$. Similarly, we define variables $\beta_{age}$, $\beta_{stage}$, and so on for each of our other covariates in the Cox model. 

Then, we leverage the proportionality between the Cox likelihood and a Poisson likelihood to express the Cox model in terms of the exposure per time interval, for an arbitarily set interval length of 0.3 (years), and whether the event (death) occurred in a given time interval for a patient/core $i$. 

$$
\begin{aligned}
\lambda_0 &\sim \mathcal{Gamma}(0.1, 0.1) \\
\lambda_i &= \lambda_0\exp(\sum_v \beta_{v,i}x_{v,i}) \\
d_i &\sim \mathcal{Poisson}(\lambda_i * p_i)
\end{aligned}
$$

where $v$ corresponds to the covariates of the Cox model, including cluster, stage, and age, $x_{v,i}$ is the value of the covariate $v$ for a given core/patient $i$, $p_i$ is the exposure for core/patient $i$ in a given interval, $d_i$ is whether or not the event (death) occurred for a core/patient $i$ in a given interval, and the index for interval has been omitted from all variables for clarity. Note that here the Gamma distribution for $\lambda_0$ is parametrized in terms of shape and rate variables, not the mean and scale.  


```{r, cache=FALSE}
use_condaenv("pymc")

survmodel_results <- py_load_object("../data/survival_model_outputs/p53abn/model_results.pkl")
```

```{r}
til_counts_clust <- lapply(names(til_counts_wide_filtered_p53abn), function(x) {
  clust_df <- data.frame(
    acc_num=unique(til_counts_wide_filtered_p53abn[[x]]$acc_num),
    clust=survmodel_results[[paste0(x, "_clust")]]
  )
  til_counts_wide_filtered_p53abn[[x]] %>%
    left_join(clust_df)
})
names(til_counts_clust) <- names(til_counts_wide_filtered_p53abn)

til_densities_clust <- lapply(til_counts_clust, function(x) {
  x %>% 
    group_by(acc_num, variable, region, clust) %>%
    summarise(total_count=sum(count),
              total_area=sum(area)) %>%
    ungroup() %>%
    mutate(density=total_count/total_area,
           variable=str_replace(variable, "^count_", ""))
})

til_densities_heatmap <- lapply(til_densities_clust, function(x) {
  dens_df <- x %>%
    mutate(variable=paste0(variable, "_", region),
           density=log(density+1)) %>%
    select(-c(total_count, total_area, region)) %>%
    pivot_wider(names_from = variable, values_from = density)
  dens_mat <- dens_df %>%
    select(-c(acc_num, clust)) %>%
    as.matrix
  rownames(dens_mat) <- dens_df$acc_num
  clust_anno <- dens_df %>%
    select(c(acc_num, clust)) %>%
    column_to_rownames("acc_num")
  return(list(mat=dens_mat, clust=clust_anno))
})
```

```{r}
density_heatmaps <- lapply(outcomes, function(outcome_type) {
  row_anno <- clinical_anno[rownames(til_densities_heatmap[[outcome_type]]$mat),] %>%
    bind_cols(til_densities_heatmap[[outcome_type]]$clust) %>%
    mutate(hist_rev = case_when(
      hist_rev %in% names(hist_mapping) ~ hist_mapping[hist_rev],
      TRUE ~ hist_rev 
    ),
    clust=factor(clust))
  
  ha <- rowAnnotation(df = row_anno, annotation_width = 0.02)
  col_fun <- colorRamp2(c(-2, 0, 2), c("blue", "white", "red"))
  
  density_heatmap <- Heatmap(sqrt(exp(til_densities_heatmap[[outcome_type]]$mat)-1) %>% scale,
                             na_col = "gray",
                             column_names_gp = gpar(fontsize = 6), 
                             cluster_rows = TRUE,
                             cluster_columns = FALSE,
                             column_names_rot = 45, 
                             show_row_names = FALSE, 
                             clustering_method_rows = "ward.D2", 
                             clustering_method_columns = "ward.D2",
                             row_split = row_anno$clust) + ha
  return(density_heatmap)
})
names(density_heatmaps) <- outcomes
```

### Overall survival

```{r}
draw(density_heatmaps$os, heatmap_legend_side = "right")
```

The effect size and $p$-value of the Cox survival model are:

```{r}
## Effect size
with(survmodel_results$os_trace_table, mean(beta_clust_1))

## p value
with(survmodel_results$os_trace_table, sum(beta_clust_1 >= 0)/nrow(survmodel_results$os_trace_table))
```

### Progression-free survival

```{r}
draw(density_heatmaps$pfs, heatmap_legend_side = "right")
```

The effect size and $p$-value of the Cox survival model are:

```{r}
## Effect size
with(survmodel_results$pfs_trace_table, mean(beta_clust_1))

## p value
with(survmodel_results$pfs_trace_table, sum(beta_clust_1 >= 0)/nrow(survmodel_results$pfs_trace_table))
```

### Disease-specific survival

```{r}
draw(density_heatmaps$dss, heatmap_legend_side = "right")
```

```{r}
## Effect size
with(survmodel_results$dss_trace_table, mean(beta_clust_1))

## p value
with(survmodel_results$dss_trace_table, sum(beta_clust_1 >= 0)/nrow(survmodel_results$dss_trace_table))
```

### Concordance between clusters from different survival outcomes

Some samples may have been clustered differently across the different outcome categories, as some outcomes are marked with 'Unk' on the input survival spreadsheet (i.e. both status and duration unknown), making the number of samples slightly different. 

```{r}
outcome_clusters_long <- lapply(outcomes, function(outcome) {
  x <- til_densities_clust[[outcome]]
  x %>%
    select(acc_num, clust) %>%
    unique %>%
    mutate(outcome=outcome)
}) %>% bind_rows() %>%
  arrange(acc_num)

outcome_clusters_long %>%
  group_by(acc_num, clust) %>%
  summarise(outcomes=list(outcome)) %>%
  ggplot(aes(x=outcomes)) + 
    geom_bar() + 
    scale_x_upset() + 
  theme_pubclean()
```

```{r}
outcome_clust_wide <- outcome_clusters_long %>%
  spread(outcome, clust) 

outcome_clust_wide %>%
  column_to_rownames("acc_num") %>%
  pheatmap(show_rownames = FALSE,
           cluster_cols = FALSE)
```

Showing that there are 2 samples where there is a disagreement between clustering between dss and os versus pfs. 

An option for making this a non-issue is to decouple the survival analysis from the TIL clustering in the neg binomial model (i.e. remove the Cox PH component). 

### Forest plots

```{r, eval = FALSE}
## Not sure what I was trying to do here?
test <- lapply(outcomes, function(outcome_type) {
  fit_labeled <- fit_data_p53abn[[outcome_type]] %>%
    bind_cols(data.frame(clust=factor(survmodel_results[[paste0(outcome_type, "_clust")]])))
  cox_fit <- coxph(Surv(time, status) ~ clust + age_dx + chemo + rt + brachy + stage_main,
      data = fit_labeled)
})
names(test) <- outcomes
```

```{r}
trace_summaries <- lapply(outcomes, function(outcome_type) {
  trace_table <- survmodel_results[[paste0(outcome_type, "_trace_table")]]
  niters <- nrow(trace_table)
  cols_pivot <- colnames(trace_table)[!str_detect(colnames(trace_table), "^props")]
  
  trace_table_long <- trace_table[,cols_pivot] %>%
    pivot_longer(cols = cols_pivot) %>%
    rename(variable=name) %>%
    mutate(outcome=outcome_type) %>%
    select(outcome, everything())
  
  trace_table_summarized <- trace_table_long %>%
    group_by(outcome, variable) %>%
    summarise(
      log.estimate=mean(value),
      log.conf.low=quantile(value, 0.025),
      log.conf.high=quantile(value, 0.975),
      p.value=min(sum(value >= 0)/length(value), sum(value <= 0)/length(value))
    ) %>%
    ungroup() %>%
    mutate(
      estimate=exp(log.estimate),
      conf.low=exp(log.conf.low),
      conf.high=exp(log.conf.high)
    )
  
  return(trace_table_summarized)
})

trace_summaries_combined <- bind_rows(trace_summaries)
```

```{r}
trace_summaries_renamed <- trace_summaries_combined %>%
  mutate(variable = str_replace(variable, "^beta_", "")) %>%
  filter(!variable %in% c("clust_0", "stage_0")) %>%
  mutate(category = case_when(
    str_detect(variable, "^stage") ~ "Stage",
    TRUE ~ "")) %>%
  mutate(variable = dplyr::recode(variable, 
                           clust_1 = "High TIL",
                           stage_1 = "II",
                           stage_2 = "III",
                           stage_3 = "IV",
                           chemo = "Chemotherapy",
                           brachy = "Brachytherapy",
                           rt = "Radiotherapy",
                           age = "Age")) %>%
  mutate(variable = factor(variable, levels = c("Age", "High TIL", "Chemotherapy", "Brachytherapy", "Radiotherapy", "II", "III", "IV")))
  

ggplot(trace_summaries_renamed, aes(y=variable, group=outcome, colour=outcome)) + 
  geom_point(aes(x=exp(log.estimate)), position=position_dodge(width=0.5), shape=15, size=3) + 
  geom_linerange(aes(xmin=exp(log.conf.low), xmax=exp(log.conf.high)), position=position_dodge(width=0.5)) + 
  theme_pubr() + 
  geom_vline(xintercept = c(0.1, 0.2, 0.5, 2, 4, 8), linetype = 3) + 
  geom_vline(xintercept = 1, alpha = 0.7) + 
  facet_col(~ category, scales = "free_y", space = "free", strip.position = "left") + 
  theme(strip.placement = "outside", strip.background = element_blank(), strip.text = element_text(face = "bold")) + 
  ylab("") + 
  scale_y_discrete(limits = rev) + 
  scale_colour_manual(values = brewer.pal(3, "Set2")) + 
  xlab("Hazard ratio") + 
  scale_x_continuous(trans = "log", breaks = c(0.1, 0.2, 0.5, 1, 2, 4, 8))

```

# Mutational signatures

```{r}
cnsig_dir <- "../huntsman_cn_signatures/OneDrive_1_9-18-2023"

cnsig_exposures_file <- file.path(cnsig_dir, "agglomerated_exposures_table.csv")
gene_files <- file.path(cnsig_dir, paste0(c("BRCA1", "BRCA2", "CCNE1", "HER2", "TP53"), ".csv"))
gene_mutation_files <- file.path(cnsig_dir, paste0(c("BRCA1", "BRCA2"), "_targeted_panel_seq.csv"))
ploidy_cellularity_file <- file.path(cnsig_dir, "30kb_aCNsolutions_20230722_196_filtered.csv")
her2_ihc_file <- file.path(cnsig_dir, "HER2_IHC_Track.xlsx")

cnsig_exposures <- read_csv(cnsig_exposures_file)
colnames(cnsig_exposures)[1] <- "sample"
cnsig_exposures <- cnsig_exposures %>% 
  filter(!str_detect(sample, "^(IM|JBLAB)")) %>%
  mutate(sample = str_replace_all(sample, "\\.", "-")) %>%
  mutate(id = case_when(
    str_detect(sample, "^VS") ~ str_extract(sample, "[^-]*\\-[^-]*"),
    str_detect(sample, "^CC") ~  str_replace(sample, "\\-T$", ""),
    str_detect(sample, "^VOA") ~ str_replace(sample, "[A-Z]*$", "")
  ))

gene_cn_status <- lapply(gene_files, function(x) {
  read_csv(x)
}) %>% bind_rows() %>% 
  filter(!str_detect(sample, "^(IM|JBLAB)")) %>%
  mutate(sample = str_replace_all(sample, "\\.", "-")) %>%
  mutate(id = case_when(
    str_detect(sample, "^VS") ~ str_extract(sample, "[^-]*\\-[^-]*"),
    str_detect(sample, "^CC") ~  str_replace(sample, "\\-T$", ""),
    str_detect(sample, "^VOA") ~ str_replace(sample, "[A-Z]*$", "")
  )) %>%
  mutate(classification = factor(classification, levels = c("High Amplification", "Amplification", "Gain", "Normal", "Loss", "No Data")))

gene_mut_status <- lapply(gene_mutation_files, function(x) {
  read_csv(x)
}) %>% bind_rows() %>% 
  filter(!str_detect(sample, "^(IM|JBLAB)")) %>%
  mutate(sample = str_replace_all(sample, "\\.", "-")) %>%
  mutate(id = case_when(
    str_detect(sample, "^VS") ~ str_extract(sample, "[^-]*\\-[^-]*"),
    str_detect(sample, "^CC") ~  str_replace(sample, "\\-T$", ""),
    str_detect(sample, "^VOA") ~ str_replace(sample, "[A-Z]*$", "")
  )) %>%
  mutate(classification = factor(classification, levels = c("Present", "Absent", "No Data")))

ploidy_cellularity <- read_csv(ploidy_cellularity_file) %>%
  filter(!str_detect(sample, "^(IM|JBLAB)")) %>%
  mutate(sample = str_replace_all(sample, "\\.", "-")) %>%
  mutate(id = case_when(
    str_detect(sample, "^VS") ~ str_extract(sample, "[^-]*\\-[^-]*"),
    str_detect(sample, "^CC") ~  str_replace(sample, "\\-T$", ""),
    str_detect(sample, "^VOA") ~ str_replace(sample, "[A-Z]*$", "")
  ))

her2_ihc <- read_xlsx(her2_ihc_file) %>%
  rename(sample=samples_id, her2_ihc=`IHC score`, her2_percent_pos=`% when 2 /3+`) %>%
  filter(!str_detect(sample, "^(IM|JBLAB)")) %>%
  mutate(id = case_when(
    str_detect(sample, "^VS") ~ str_extract(sample, "[^-]*\\-[^-]*"),
    str_detect(sample, "^CC") ~  str_replace(sample, "\\-T$", ""),
    str_detect(sample, "^VOA") ~ str_replace(sample, "[A-Z]*$", "")
  )) %>%
  mutate(her2_ihc = factor(her2_ihc, levels = c(0, 1, 2, 3))) %>%
  select(sample, id, her2_ihc, her2_percent_pos)

correct_identifiers <- clinical_data_unique %>%
  select(patient_id, study_id, acc_num) 

## Fix seemingly arbitrary identifier usage made by collaborators
merge_on_all_identifiers <- function(df, identifiers) {
  identifiers_subset <- identifiers %>%
    filter(patient_id %in% df$id | study_id %in% df$id | acc_num %in% df$id) %>%
    mutate(id = case_when(
      patient_id %in% df$id ~ patient_id,
      study_id %in% df$id ~ study_id,
      acc_num %in% df$id ~ acc_num
    ))
  
  df <- df %>%
    inner_join(identifiers_subset) %>%
    select(-c(sample, id)) %>%
    select(patient_id, study_id, acc_num, everything())
  
  return(df)
}


cnsig_exposures <- merge_on_all_identifiers(cnsig_exposures, correct_identifiers)
gene_cnvs <- merge_on_all_identifiers(gene_cn_status, correct_identifiers)
gene_muts <- merge_on_all_identifiers(gene_mut_status, correct_identifiers)
ploidy_cellularity <- merge_on_all_identifiers(ploidy_cellularity, correct_identifiers)
her2_ihc <- merge_on_all_identifiers(her2_ihc, correct_identifiers) 
```

As the TIL clusters are highly concordant across survival outcome types, we'll use the ones from os, dss > pfs (as pfs has the discrepancy with two samples). 

```{r}
outcome_clust_unified <- outcome_clust_wide %>%
  mutate(clust = case_when(
    !is.na(os) ~ os,
    !is.na(dss) ~ dss,
    !is.na(pfs) ~ pfs
  ))

cnsig_exposures_tilclusts <- cnsig_exposures %>% 
  inner_join(outcome_clust_unified)
```

## CN signature exposures

```{r}
cnsig_exposures_matrix <- cnsig_exposures_tilclusts %>%
  select(acc_num, VS1, VS2, VS3, VS4, VS5, BS1, BS2, BS3, BS4, BS5, BS6, BS7) %>%
  column_to_rownames("acc_num") %>%
  scale

cnsig_exposures_anno <- cnsig_exposures_tilclusts %>%
  select(acc_num, clust) %>%
  mutate(clust=factor(clust))

gene_cnvs_anno <- gene_cnvs %>% 
  select(acc_num, gene, classification) %>%
  spread(gene, classification)

gene_muts_anno <- gene_muts %>%
  select(acc_num, gene, classification) %>%
  mutate(gene = paste0(gene, "_m")) %>%
  spread(gene, classification)

ploidy_anno <- ploidy_cellularity %>%
  select(acc_num, ploidy, cellularity)

her2_anno <- her2_ihc %>%
  select(acc_num, her2_ihc)

cnsig_exposures_anno <- cnsig_exposures_anno %>%
  left_join(gene_cnvs_anno) %>%
  left_join(gene_muts_anno) %>%
  left_join(ploidy_anno) %>%
  left_join(her2_anno) %>%
  column_to_rownames("acc_num")
  
cn_color_map <- c(
  'High Amplification'='#982649',
  'Amplification'='#E0479E',
  'Gain'='#EA7317',
  'Normal'='#C3D350',
  'Loss'='#001242',
  'No Data'='#B7B6C1'
)

mut_color_map <- c(
  'Present'='#982649',
  'Absent'='#C3D350',
  'No Data'='#B7B6C1'
)

her2_color_map <- c(
  '0'='#6D6466',
  '1'='#06BCC1',
  '2'='#EE7B30',
  '3'='#A20021'
)

clust_color_map <- c('0'='#60B2E5',
                     '1'='#A4031F')


ha <- rowAnnotation(df = cnsig_exposures_anno, annotation_width = 0.02, 
                    col = list(
                      clust=clust_color_map,
                      BRCA1=cn_color_map,
                      BRCA2=cn_color_map,
                      CCNE1=cn_color_map,
                      HER2=cn_color_map,
                      TP53=cn_color_map,
                      BRCA1_m=mut_color_map,
                      BRCA2_m=mut_color_map,
                      her2_ihc=her2_color_map,
                      ploidy=colorRamp2(c(min(ploidy_anno$ploidy), 2, max(ploidy_anno$ploidy)), c("blue", "white", "red")),
                      cellularity=colorRamp2(c(0, 1), c("white", "red"))
                    )
)

cnsig_heatmap <- Heatmap(cnsig_exposures_matrix,
                         na_col = "gray",
                         column_names_gp = gpar(fontsize = 6),
                         column_names_rot = 45, 
                         show_row_names = FALSE) + ha

cnsig_heatmap_split <- Heatmap(cnsig_exposures_matrix,
                               na_col = "gray",
                               column_names_gp = gpar(fontsize = 6),
                               column_names_rot = 45, 
                               show_row_names = FALSE,
                               row_split = cnsig_exposures_anno$clust) + ha

```

```{r, fig.width = 9, fig.height=6}
draw(cnsig_heatmap, heatmap_legend_side = "right")
```

```{r, fig.width = 9, fig.height=6}
draw(cnsig_heatmap_split, heatmap_legend_side = "right")
```

### CCNE1 HLAMP

We can see a slight increase in CCNE1 HLAMP in clust == 0, but there are no obvious differences in BRCA1/2 copy number (though Dawn did say these were possibly unreliable?). We'll do a quick statistical check for CCNE1:

```{r}
ccne1_table <- with(cnsig_exposures_anno %>% filter(CCNE1 != "No Data"), table(CCNE1 == "High Amplification", clust))

fisher.test(ccne1_table)
ccne1_table
```

### HER2 AMP/HLAMP

We can see a slight increase in HER2 AMP/HLAMP in clust == 1. 

```{r}
her2_table <- with(cnsig_exposures_anno %>% filter(HER2 != "No Data"), table(HER2 == "High Amplification" | HER2 == "Amplification", clust))

fisher.test(her2_table)
her2_table
```



```{r}
her2_ihc_table <- with(cnsig_exposures_anno %>% filter(!is.na(her2_ihc)), table(her2_ihc %in% c('2', '3'), clust))

fisher.test(her2_ihc_table)
her2_ihc_table
```

This does not seem to be reflected in IHC results, however, for whatever reason. There is a correlation between HER2 IHC and sWGS copy number status, as below, though the correlation is not fantastic (5 3+ samples have normal copy number by sWGS!). 

```{r}
with(cnsig_exposures_anno, table(HER2, her2_ihc))
```

### Signature exposures by TIL cluster

```{r}
cnsig_exposures_tilclusts_long <- cnsig_exposures_tilclusts %>%
  gather(key = "signature", value = "exposure", -c(patient_id, study_id, acc_num, os, dss, pfs, clust, max_brenton_sig, max_van_sig))

ggplot(cnsig_exposures_tilclusts_long, aes(x=factor(clust), y=exposure)) + 
  geom_boxplot(width = 0.3, outlier.size = -1) + 
  geom_point(position = position_jitter(width = 0.1), alpha = 0.2) + 
  facet_wrap(~ signature, scales = "free_y") + 
  stat_compare_means(vjust = 0.7, size = 3) + 
  theme_pubr()
```

BS6 is likely carrying some FBI information ... even though this was not originally identified in the Brenton paper. 

### Ploidy/cellularity by TIL cluster

```{r}
ploidy_clust <- ploidy_anno %>%
  inner_join(outcome_clust_unified)

ploidy_clust_long <- ploidy_clust %>%
  gather(key = "measure", value = "value", -c(acc_num, dss, os, pfs, clust))

ggplot(ploidy_clust_long, aes(x=factor(clust), y=value)) + 
  geom_boxplot(width = 0.3, outlier.size = -1) + 
  geom_point(position = position_jitter(width = 0.1), alpha = 0.2) + 
  facet_wrap(~ measure, scales = "free_y") + 
  stat_compare_means(vjust = 0.7, size = 3) + 
  theme_pubr()
```


# Outputs

Write outputs that we need for other analyses. 

```{r, eval = FALSE}
## TIL densities table after preprocessing 
til_densities_output <- til_densities_sum_long %>%
  select(acc_num, variable, value, area) %>%
  rename(density=value) 

write_tsv(til_densities_output, file = "../results/til_densities_output.tsv")
```

```{r}
## NB clusters for each model, long format
write_tsv(outcome_clusters_long, file = "../results/outcome_clusters_long.tsv")
```
